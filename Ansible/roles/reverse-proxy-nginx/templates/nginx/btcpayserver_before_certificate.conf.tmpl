{% for item in proxy_to_tor_hosts %}
server {
  listen 80;
  server_name {{ item.proxy_sink }};

  # Let's Encrypt verification requests
  location ^~ /.well-known/acme-challenge/ {
    allow all;
    root /var/lib/letsencrypt/;
    default_type "text/plain";
    try_files $uri =404;
  }

  # Redirect everything else to https
  location / {
    return 301 https://$server_name$request_uri;
  }
}

{% endfor %}

{% for item in proxy_to_wireguard_hosts %}
server {
  listen 80;
  server_name {{ item.proxy_sink }};

  # Let's Encrypt verification requests
  location ^~ /.well-known/acme-challenge/ {
    allow all;
    root /var/lib/letsencrypt/;
    default_type "text/plain";
    try_files $uri =404;
  }

  # Redirect everything else to https
  location / {
    return 301 https://$server_name$request_uri;
  }
}

{% endfor %}